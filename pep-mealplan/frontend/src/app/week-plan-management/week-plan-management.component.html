@if (!isloading()) {
    <div class="grid grid-cols-[3fr_1fr] bg-slate-50 min-h-screen">
        <!-- LINKER BEREICH: WOCHENPLAN -->
        <div class="rounded-xl">
            <h1 class="text-2xl font-bold text-black bg-slate-200 p-2 text-center">
                WOCHENPLAN
            </h1>

            <div class="flex p-2 justify-between items-center bg-slate-200">
                <p-button
                        (click)="exportAsWord()"
                        label="Als Word herunterladen"
                        severity="danger"
                >
                </p-button>

                <p-button
                        (click)="onSaveSelections()"
                        label="Speichern"
                        severity="success"
                        [disabled]="!hasAnySelectionForSelectedPerson()"
                >
                </p-button>
            </div>

            <div
                    class="grid grid-cols-6 gap-4 text-center max-h-[80vh] overflow-y-auto
               bg-white shadow-md relative select-none box-border rounded-b-2xl p-5"
            >
                <!-- Sticky Header -->
                <div class="col-span-6 bg-white font-bold p-4 sticky top-0 z-10">
                    <!-- WEEK SWITCHER -->
                    <div class="flex items-center justify-center gap-3">
                        <p-button
                                icon="pi pi-chevron-left"
                                severity="secondary"
                                [rounded]="true"
                                [text]="true"
                                (click)="prevWeek()"
                        ></p-button>

                        <!-- Week + first date of that week -->
                        <div class="flex flex-col items-center leading-tight">
                            <div class="font-bold text-sm">
                                Week {{ activeWeekIndex + 1 }}
                            </div>
                            <div class="text-[11px] font-semibold text-gray-600">
                                {{ dateCleaned(0) }}
                            </div>
                        </div>

                        <p-button
                                icon="pi pi-chevron-right"
                                severity="secondary"
                                [rounded]="true"
                                [text]="true"
                                (click)="nextWeek()"
                        ></p-button>
                    </div>

                    <div class="flex justify-between items-center gap-2 mt-3">
                        <div class="flex-1 p-2 text-center bg-[#e6f0ff] rounded font-bold text-xs md:text-sm">
                            SUPPE
                        </div>
                        <div class="flex-1 p-2 text-center bg-[#e6f0ff] rounded font-bold text-xs md:text-sm">
                            1. MENÜ
                        </div>
                        <div class="flex-1 p-2 text-center bg-[#e6f0ff] rounded font-bold text-xs md:text-sm">
                            2. MENÜ
                        </div>
                        <div class="flex-1 p-2 text-center bg-[#e6f0ff] rounded font-bold text-xs md:text-sm">
                            DESSERT
                        </div>
                        <div class="flex-1 p-2 text-center bg-[#e6f0ff] rounded font-bold text-xs md:text-sm">
                            1. ABEND
                        </div>
                        <div class="flex-1 p-2 text-center bg-[#e6f0ff] rounded font-bold text-xs md:text-sm">
                            2. ABEND
                        </div>
                    </div>
                </div>

                <!-- Tageszeilen -->
                @for (dayPlan of currentWeekPlan!.dayPlans; track dayPlan; let i = $index) {
                    <div
                            class="col-span-6 font-bold text-xs rounded-3xl
                   text-gray-800 bg-[#eef3f9] px-2 py-2 my-1"
                    >
                        {{ WEEK_DAYS[i] }} - {{ dateCleaned(i) }}
                    </div>

                    <!-- SUPPE -->
                    <div
                            class="border border-gray-300 p-2 rounded-2xl flex justify-center items-center h-[70px] text-xs
                   md:text-sm font-bold shadow-sm transition-transform duration-200
                   select-none cursor-pointer overflow-hidden bg-[#ffe9cc]"
                    >
                        @if (dayPlan.daySoup) {
                            <div class="text-xs md:text-sm px-1">
                                <p>{{ dayPlan.daySoup }}</p>
                            </div>
                        }
                    </div>

                    <!-- MENÜ 1 -->
                    <div
                            (click)="toggleMenu(dayPlan, 'one')"
                            [ngClass]="{
              'opacity-40': dayPlan.selectedMenu === 'two',
              'ring-2 ring-green-500': dayPlan.selectedMenu === 'one'
            }"
                            class="border border-gray-300 p-2 flex justify-center items-center
                   h-[70px] text-xs md:text-sm font-bold shadow-sm transition-transform
                   duration-200 select-none cursor-pointer overflow-hidden bg-[#d9f7d9] rounded-2xl"
                    >
                        @if (dayPlan.menuOne) {
                            <div class="text-xs md:text-sm px-1">
                                <p>{{ dayPlan.menuOne }}</p>
                            </div>
                        }
                    </div>

                    <!-- MENÜ 2 -->
                    <div
                            (click)="toggleMenu(dayPlan, 'two')"
                            [ngClass]="{
              'opacity-40': dayPlan.selectedMenu === 'one',
              'ring-2 ring-green-500': dayPlan.selectedMenu === 'two'
            }"
                            class="border border-gray-300 p-2 rounded-2xl flex justify-center items-center h-[70px] text-xs md:text-sm
                   font-bold shadow-sm transition-transform duration-200 select-none cursor-pointer overflow-hidden bg-[#d9f7d9]"
                    >
                        @if (dayPlan.menuTwo) {
                            <div class="text-xs md:text-sm px-1">
                                <p>{{ dayPlan.menuTwo }}</p>
                            </div>
                        }
                    </div>

                    <!-- DESSERT -->
                    <div
                            class="border border-gray-300 p-2 rounded-2xl flex justify-center items-center h-[70px] text-xs md:text-sm
                   font-bold shadow-sm transition-transform duration-200 select-none cursor-pointer overflow-hidden bg-[#ffdce0]"
                    >
                        @if (dayPlan.dessert) {
                            <div class="text-xs md:text-sm px-1">
                                <p>{{ dayPlan.dessert }}</p>
                            </div>
                        }
                    </div>

                    <!-- ABEND 1 -->
                    <div
                            (click)="toggleEvening(dayPlan, 'one')"
                            [ngClass]="{
              'opacity-40': dayPlan.selectedEvening === 'two',
              'ring-2 ring-blue-500': dayPlan.selectedEvening === 'one'
            }"
                            class="border border-gray-300 p-2 flex rounded-2xl justify-center items-center h-[70px] text-xs md:text-sm
                   font-bold shadow-sm transition-transform duration-200 select-none cursor-pointer overflow-hidden bg-[#ddeeff]"
                    >
                        @if (dayPlan.eveningOne) {
                            <div class="text-xs md:text-sm px-1">
                                <p>{{ dayPlan.eveningOne }}</p>
                            </div>
                        }
                    </div>

                    <!-- ABEND 2 -->
                    <div
                            (click)="toggleEvening(dayPlan, 'two')"
                            [ngClass]="{
              'opacity-40': dayPlan.selectedEvening === 'one',
              'ring-2 ring-blue-500': dayPlan.selectedEvening === 'two'
            }"
                            class="border border-gray-300 p-2 flex rounded-2xl justify-center items-center h-[70px] text-xs md:text-sm
                   font-bold shadow-sm transition-transform duration-200 select-none cursor-pointer overflow-hidden bg-[#ddeeff]"
                    >
                        @if (dayPlan.eveningTwo) {
                            <div class="text-xs md:text-sm px-1">
                                <p>{{ dayPlan.eveningTwo }}</p>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- RECHTER BEREICH: PERSONEN-LISTE -->
        <div>
            <div class="card flex justify-center">
                <p-listbox
                        [options]="personSelectorList"
                        [(ngModel)]="selectedPersonOption"
                        (ngModelChange)="onPersonSelected($event)"
                        optionLabel="name"
                        [filter]="true"
                        [listStyle]="{ 'max-height': '80vh', 'overflow': 'auto' }"
                        [filterPlaceHolder]="'Nach name suchen...'"
                        class="w-full"
                >
                    <ng-template pTemplate="item" let-person>
                        <div class="flex items-center justify-between w-full gap-2">
                            <div class="flex items-center gap-2">
                                @if (person.hasSelection && (person.missingCount ?? 0) === 0) {
                                    <i class="pi pi-check text-green-500 text-xs"></i>
                                }
                                <span>{{ person.name }}</span>
                            </div>

                            @if (person.hasSelection && (person.missingCount ?? 0) > 0) {
                                <span class="text-[11px] font-bold px-2 py-1 rounded-full bg-red-100 text-red-700">
                  {{ person.missingCount }} offen
                </span>
                            }
                        </div>
                    </ng-template>
                </p-listbox>
            </div>
        </div>
    </div>
} @else {
    <div class="flex flex-col justify-center items-center h-screen gap-4">
        <div class="text-center">
            <p-progressSpinner
                    strokeWidth="8"
                    fill="transparent"
                    animationDuration=".5s"
                    [style]="{ width: '50px', height: '50px' }"
            />
            <p class="p-5">WOCHENPLAN Loading</p>
        </div>
    </div>
}