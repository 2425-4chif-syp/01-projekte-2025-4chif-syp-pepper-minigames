@if (!isLoading) {
    <div cdkDropListGroup class="min-h-screen bg-slate-50 p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Page Header -->
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-slate-800">Rasterplan erstellen</h1>
                <p class="text-slate-500 mt-1">Drag & Drop zum Erstellen des 4-Wochen-Speiseplans</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-6">
                <!-- LEFT: Raster Plan -->
                <p-card styleClass="shadow-md">
                    <!-- Week Switcher -->
                    <div class="flex items-center justify-center gap-4 mb-6">
                        <p-button
                            icon="pi pi-chevron-left"
                            [rounded]="true"
                            [outlined]="true"
                            (onClick)="prevWeek()"
                        ></p-button>

                        <div class="text-center min-w-32">
                            <div class="text-lg font-bold text-slate-800">Woche {{ currentWeek }}</div>
                        </div>

                        <p-button
                            icon="pi pi-chevron-right"
                            [rounded]="true"
                            [outlined]="true"
                            (onClick)="nextWeek()"
                        ></p-button>
                    </div>

                    <!-- Column Headers -->
                    <div class="grid grid-cols-6 gap-2 mb-4">
                        <div class="p-2 text-center bg-amber-100 rounded-lg font-semibold text-xs text-amber-800">Suppe</div>
                        <div class="p-2 text-center bg-green-100 rounded-lg font-semibold text-xs text-green-800">Menü 1</div>
                        <div class="p-2 text-center bg-green-100 rounded-lg font-semibold text-xs text-green-800">Menü 2</div>
                        <div class="p-2 text-center bg-pink-100 rounded-lg font-semibold text-xs text-pink-800">Nachspeise</div>
                        <div class="p-2 text-center bg-blue-100 rounded-lg font-semibold text-xs text-blue-800">Abend 1</div>
                        <div class="p-2 text-center bg-blue-100 rounded-lg font-semibold text-xs text-blue-800">Abend 2</div>
                    </div>

                    <!-- Day Rows -->
                    <div class="max-h-[60vh] overflow-y-auto space-y-4">
                        @for (dayPlan of currentWeekPlan.dayPlans; track dayPlan; let i = $index) {
                            <!-- Day Header -->
                            <div class="font-semibold text-sm text-slate-700 bg-slate-100 px-3 py-2 rounded-lg">
                                {{ WEEK_DAYS[i] }}
                            </div>

                            <div class="grid grid-cols-6 gap-2">
                                <!-- Soup -->
                                <div
                                    cdkDropList
                                    [cdkDropListEnterPredicate]="soupPredicate"
                                    (cdkDragEntered)="onDragEntered($event)"
                                    (cdkDragExited)="onDragExited($event)"
                                    (cdkDropListDropped)="onSoupDrop($event, dayPlan)"
                                    [id]="'drop-daySoup-' + i"
                                    class="h-14 rounded-xl bg-amber-50 border border-amber-200 flex items-center justify-center p-1 text-xs font-medium text-center cursor-pointer transition-all hover:shadow-md"
                                    [class.border-dashed]="!dayPlan.daySoup"
                                    [class.border-red-400]="!isDropAllowed"
                                >
                                    @if (dayPlan.daySoup) {
                                        <div cdkDrag class="px-2 py-1 bg-amber-100 rounded text-amber-800 text-xs truncate max-w-full" (click)="removeFood(dayPlan, 'daySoup')">
                                            {{ dayPlan.daySoup }}
                                        </div>
                                    }
                                </div>

                                <!-- Menu 1 -->
                                <div
                                    cdkDropList
                                    [cdkDropListEnterPredicate]="mainPredicate"
                                    (cdkDragEntered)="onDragEntered($event)"
                                    (cdkDragExited)="onDragExited($event)"
                                    (cdkDropListDropped)="onMainDrop($event, dayPlan, 'menuOne')"
                                    [id]="'drop-menuOne-' + i"
                                    class="h-14 rounded-xl bg-green-50 border border-green-200 flex items-center justify-center p-1 text-xs font-medium text-center cursor-pointer transition-all hover:shadow-md"
                                    [class.border-dashed]="!dayPlan.menuOne"
                                    [class.border-red-400]="!isDropAllowed"
                                >
                                    @if (dayPlan.menuOne) {
                                        <div cdkDrag class="px-2 py-1 bg-green-100 rounded text-green-800 text-xs truncate max-w-full" (click)="removeFood(dayPlan, 'menuOne')">
                                            {{ dayPlan.menuOne }}
                                        </div>
                                    }
                                </div>

                                <!-- Menu 2 -->
                                <div
                                    cdkDropList
                                    [cdkDropListEnterPredicate]="mainPredicate"
                                    (cdkDragEntered)="onDragEntered($event)"
                                    (cdkDragExited)="onDragExited($event)"
                                    (cdkDropListDropped)="onMainDrop($event, dayPlan, 'menuTwo')"
                                    [id]="'drop-menuTwo-' + i"
                                    class="h-14 rounded-xl bg-green-50 border border-green-200 flex items-center justify-center p-1 text-xs font-medium text-center cursor-pointer transition-all hover:shadow-md"
                                    [class.border-dashed]="!dayPlan.menuTwo"
                                    [class.border-red-400]="!isDropAllowed"
                                >
                                    @if (dayPlan.menuTwo) {
                                        <div cdkDrag class="px-2 py-1 bg-green-100 rounded text-green-800 text-xs truncate max-w-full" (click)="removeFood(dayPlan, 'menuTwo')">
                                            {{ dayPlan.menuTwo }}
                                        </div>
                                    }
                                </div>

                                <!-- Dessert -->
                                <div
                                    cdkDropList
                                    [cdkDropListEnterPredicate]="dessertPredicate"
                                    (cdkDragEntered)="onDragEntered($event)"
                                    (cdkDragExited)="onDragExited($event)"
                                    (cdkDropListDropped)="onDessertDrop($event, dayPlan)"
                                    [id]="'drop-dessert-' + i"
                                    class="h-14 rounded-xl bg-pink-50 border border-pink-200 flex items-center justify-center p-1 text-xs font-medium text-center cursor-pointer transition-all hover:shadow-md"
                                    [class.border-dashed]="!dayPlan.dessert"
                                    [class.border-red-400]="!isDropAllowed"
                                >
                                    @if (dayPlan.dessert) {
                                        <div cdkDrag class="px-2 py-1 bg-pink-100 rounded text-pink-800 text-xs truncate max-w-full" (click)="removeFood(dayPlan, 'dessert')">
                                            {{ dayPlan.dessert }}
                                        </div>
                                    }
                                </div>

                                <!-- Evening 1 -->
                                <div
                                    cdkDropList
                                    [cdkDropListEnterPredicate]="mainPredicate"
                                    (cdkDragEntered)="onDragEntered($event)"
                                    (cdkDragExited)="onDragExited($event)"
                                    (cdkDropListDropped)="onMainDrop($event, dayPlan, 'eveningOne')"
                                    [id]="'drop-eveningOne-' + i"
                                    class="h-14 rounded-xl bg-blue-50 border border-blue-200 flex items-center justify-center p-1 text-xs font-medium text-center cursor-pointer transition-all hover:shadow-md"
                                    [class.border-dashed]="!dayPlan.eveningOne"
                                    [class.border-red-400]="!isDropAllowed"
                                >
                                    @if (dayPlan.eveningOne) {
                                        <div cdkDrag class="px-2 py-1 bg-blue-100 rounded text-blue-800 text-xs truncate max-w-full" (click)="removeFood(dayPlan, 'eveningOne')">
                                            {{ dayPlan.eveningOne }}
                                        </div>
                                    }
                                </div>

                                <!-- Evening 2 -->
                                <div
                                    cdkDropList
                                    [cdkDropListEnterPredicate]="mainPredicate"
                                    (cdkDragEntered)="onDragEntered($event)"
                                    (cdkDragExited)="onDragExited($event)"
                                    (cdkDropListDropped)="onMainDrop($event, dayPlan, 'eveningTwo')"
                                    [id]="'drop-eveningTwo-' + i"
                                    class="h-14 rounded-xl bg-blue-50 border border-blue-200 flex items-center justify-center p-1 text-xs font-medium text-center cursor-pointer transition-all hover:shadow-md"
                                    [class.border-dashed]="!dayPlan.eveningTwo"
                                    [class.border-red-400]="!isDropAllowed"
                                >
                                    @if (dayPlan.eveningTwo) {
                                        <div cdkDrag class="px-2 py-1 bg-blue-100 rounded text-blue-800 text-xs truncate max-w-full" (click)="removeFood(dayPlan, 'eveningTwo')">
                                            {{ dayPlan.eveningTwo }}
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </p-card>

                <!-- RIGHT: Food List -->
                <p-card styleClass="shadow-md">
                    <ng-template pTemplate="header">
                        <div class="px-4 pt-4">
                            <h2 class="text-lg font-semibold text-slate-800">Gerichte</h2>
                        </div>
                    </ng-template>

                    <!-- Search -->
                    <div class="mb-4">
                        <span class="p-input-icon-left w-full">
                            <i class="pi pi-search"></i>
                            <input
                                pInputText
                                [formControl]="nameFilter"
                                type="text"
                                placeholder="Suchen..."
                                class="w-full"
                            />
                        </span>
                    </div>

                    <!-- Food List -->
                    <div
                        cdkDropList
                        (cdkDropListDropped)="dropFoodInFoods($event)"
                        class="max-h-[55vh] overflow-y-auto space-y-2"
                    >
                        @if (!searchLoading) {
                            @for (food of filteredFood; track food) {
                                <div
                                    cdkDrag
                                    [cdkDragData]="food"
                                    (mouseenter)="showTooltip(food, $event)"
                                    (mouseleave)="hideTooltip()"
                                    class="p-3 bg-white border border-slate-200 rounded-lg cursor-grab hover:border-indigo-300 hover:bg-indigo-50 transition-all"
                                    [class.bg-slate-200]="isFoodUsed(food)"
                                    [class.text-slate-400]="isFoodUsed(food)"
                                >
                                    <div class="flex items-center gap-2">
                                        <p-tag
                                            [value]="getFoodTypeLabel(food.type)"
                                            [severity]="getFoodTypeSeverity(food.type)"
                                            [rounded]="true"
                                        ></p-tag>
                                        <span class="text-sm font-medium truncate">{{ food.name }}</span>
                                    </div>
                                </div>
                            }

                            @if (tooltip.visible) {
                                <div
                                    class="fixed z-50 bg-slate-800 text-white px-3 py-2 rounded-lg text-sm max-w-xs shadow-lg"
                                    [style.top.px]="tooltip.y"
                                    [style.left.px]="tooltip.x"
                                >
                                    <div [innerHTML]="tooltip.content"></div>
                                </div>
                            }
                        } @else {
                            <div class="flex items-center justify-center py-12">
                                <p-progressSpinner [style]="{ width: '40px', height: '40px' }" strokeWidth="4"></p-progressSpinner>
                            </div>
                        }
                    </div>
                </p-card>
            </div>
        </div>
    </div>
} @else {
    <div class="flex flex-col items-center justify-center h-screen bg-slate-50">
        <p-progressSpinner [style]="{ width: '50px', height: '50px' }" strokeWidth="4"></p-progressSpinner>
        <p class="mt-4 text-slate-500">Raster wird geladen...</p>
    </div>
}
